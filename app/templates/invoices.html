{% extends "base.html" %}

{% block title %}Outstanding Invoices - FinHealthMonitor{% endblock %}

{% block content %}
        <div class="content-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2>Outstanding Invoices</h2>
                <div style="display: flex; align-items: center; gap: 10px;">
                    {% include "_connection_selector.html" %}
                    {% if selected_connection and selected_connection.software == "xero" %}
                        {% include "_tenant_selector.html" %}
                    {% endif %}
                </div>
            </div>
            
            {% if async_mode and not invoices %}
            <!-- Loading State with Skeleton Table -->
            <div id="loading-container">
                <p id="loading-message" style="margin-bottom: 20px;">Fetching invoices from {{ selected_connection.software|title if selected_connection else 'connection' }}...</p>
                
                <!-- Skeleton Table -->
                <table class="skeleton-table">
                    <thead>
                        <tr>
                            <th>Invoice Number</th>
                            <th>Contact</th>
                            <th>Date</th>
                            <th>Due Date</th>
                            <th>Total</th>
                            <th>Amount Due</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for i in range(10) %}
                        <tr>
                            <td class="skeleton-cell">
                                <div class="skeleton-bar short"></div>
                            </td>
                            <td class="skeleton-cell">
                                <div class="skeleton-bar medium"></div>
                            </td>
                            <td class="skeleton-cell">
                                <div class="skeleton-bar short"></div>
                            </td>
                            <td class="skeleton-cell">
                                <div class="skeleton-bar short"></div>
                            </td>
                            <td class="skeleton-cell">
                                <div class="skeleton-bar short"></div>
                            </td>
                            <td class="skeleton-cell">
                                <div class="skeleton-bar short"></div>
                            </td>
                            <td class="skeleton-cell">
                                <div class="skeleton-badge"></div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                <!-- Progress Bar -->
                <div class="progress-container" style="margin-top: 20px;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-bar" style="width: 0%;">
                            <span id="progress-percentage">0%</span>
                        </div>
                    </div>
                    <p id="progress-message" style="margin-top: 10px; text-align: center;">Initializing...</p>
                </div>
            </div>
            <script>
                (function() {
                    const sessionId = "{{ session_id }}";
                    let pollInterval;
                    let pollCount = 0;
                    const maxPolls = 300; // 5 minutes max (1 poll per second)
                    
                    function updateProgress(progress, message) {
                        const progressBar = document.getElementById('progress-bar');
                        const progressPercentage = document.getElementById('progress-percentage');
                        const progressMessage = document.getElementById('progress-message');
                        
                        if (progressBar) {
                            progressBar.style.width = progress + '%';
                            const percentageSpan = progressBar.querySelector('#progress-percentage');
                            if (percentageSpan) percentageSpan.textContent = progress + '%';
                        }
                        if (progressMessage) {
                            progressMessage.textContent = message;
                        }
                    }
                    
                    function pollProgress() {
                        pollCount++;
                        if (pollCount > maxPolls) {
                            clearInterval(pollInterval);
                            updateProgress(0, 'Request timed out. Please refresh the page.');
                            return;
                        }
                        
                        fetch('/invoices/progress')
                            .then(response => response.json())
                            .then(data => {
                                updateProgress(data.progress || 0, data.message || 'Loading...');
                                
                                if (data.status === 'complete') {
                                    clearInterval(pollInterval);
                                    // Reload the page to show results
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 500);
                                } else if (data.status === 'error') {
                                    clearInterval(pollInterval);
                                    updateProgress(0, 'Error: ' + (data.error || 'Unknown error'));
                                    setTimeout(() => {
                                        window.location.href = '/invoices?async=false';
                                    }, 2000);
                                }
                            })
                            .catch(error => {
                                console.error('Error polling progress:', error);
                            });
                    }
                    
                    // Start polling immediately, then every second
                    pollProgress();
                    pollInterval = setInterval(pollProgress, 1000);
                })();
            </script>
            {% else %}
            <div class="summary-stats">
                <div class="stat-card">
                    <div class="stat-label">Total Invoices</div>
                    <div class="stat-value">{{ invoice_count }}</div>
                </div>
                <div class="stat-card stat-card-primary">
                    <div class="stat-label">Total Outstanding</div>
                    <div class="stat-value">${{ "%.2f"|format(total_outstanding) }}</div>
                </div>
            </div>
            
            {% if invoices %}
            <table class="accounts-table">
                <thead>
                    <tr>
                        <th>Invoice Number</th>
                        <th>Contact</th>
                        <th>Date</th>
                        <th>Due Date</th>
                        <th>Total</th>
                        <th>Amount Due</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for invoice in invoices %}
                    <tr>
                        <td>{{ invoice.InvoiceNumber or invoice.get('InvoiceNumber', '-') }}</td>
                        <td class="row-text-bold">{{ invoice.Contact.Name if invoice.Contact else '-' }}</td>
                        <td>{{ invoice.Date[:10] if invoice.Date else '-' }}</td>
                        <td>{{ invoice.DueDate[:10] if invoice.DueDate else '-' }}</td>
                        <td>${{ "%.2f"|format(invoice.Total or 0) }}</td>
                        <td>${{ "%.2f"|format(invoice.AmountDue or 0) }}</td>
                        <td>
                            <span class="status-badge status-{{ (invoice.Status or '').lower() }}">
                                <span>{{ invoice.Status or 'UNKNOWN' }}</span>
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- Pagination Control -->
            <div class="pagination-control">
                <button id="prevPage" onclick="navigatePage(-1)" disabled>
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button id="nextPage" onclick="navigatePage(1)">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            {% else %}
            <div class="empty-state">
                <p>No outstanding invoices found.</p>
            </div>
            {% endif %}
            {% endif %}
        </div>
{% endblock %}

{% block extra_js %}
<script>
    // Pagination functionality
    let currentPage = 1;
    const rowsPerPage = 10;
    
    function navigatePage(direction) {
        const table = document.querySelector('.accounts-table');
        if (!table) return;
        
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        const totalPages = Math.ceil(rows.length / rowsPerPage);
        
        currentPage += direction;
        
        if (currentPage < 1) currentPage = 1;
        if (currentPage > totalPages) currentPage = totalPages;
        
        // Hide all rows
        rows.forEach(row => row.style.display = 'none');
        
        // Show rows for current page
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        rows.slice(start, end).forEach(row => row.style.display = '');
        
        // Update button states
        const prevBtn = document.getElementById('prevPage');
        const nextBtn = document.getElementById('nextPage');
        
        if (prevBtn) prevBtn.disabled = currentPage === 1;
        if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
    }
    
    // Initialize pagination on page load
    document.addEventListener('DOMContentLoaded', function() {
        const table = document.querySelector('.accounts-table');
        if (table) {
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            if (rows.length > rowsPerPage) {
                navigatePage(0); // Initialize to show first page
            } else {
                // Hide pagination if not needed
                const pagination = document.querySelector('.pagination-control');
                if (pagination) pagination.style.display = 'none';
            }
        }
    });
</script>
{% endblock %}

