<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payroll Risk - FinHealthMonitor</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>FinHealthMonitor</h1>
            <div class="header-actions">
                <span class="tenant-name">Organization: {{ tenant_name }}</span>
                <div class="dropdown">
                    <button class="dropbtn">Menu ‚ñº</button>
                    <div class="dropdown-content">
                        <a href="/">Home</a>
                        <a href="/settings">Settings</a>
                        <a href="/payroll-risk" class="active">Payroll Risk</a>
                        <a href="/accounts">Chart of Account</a>
                        <a href="/invoices">Outstanding Invoices</a>
                        <a href="/manual-journals">Manual Journals</a>
                        <a href="/bank-transactions">Bank Transactions</a>
                    </div>
                </div>
                <a href="/logout" class="btn btn-secondary">Logout</a>
            </div>
        </header>

        {% if error %}
        <div class="error-message">
            <strong>Error:</strong> {{ error }}
        </div>
        {% endif %}

        <div class="content-section">
            <h2>Payroll Risk Early Warning</h2>
            <p>Analyze your cash position to determine if projected cash will cover the next payroll.</p>
            
            {% if run_analysis and not has_result and not error %}
            <!-- Loading State with Progress -->
            {% if async_mode %}
            <div id="loading-indicator" style="margin-top: 30px; text-align: center; padding: 40px;">
                <div class="loading-spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <h3 style="color: #667eea; margin-bottom: 10px;">Payroll Risk Analysis in Progress</h3>
                <p id="progress-message" style="color: #666; margin-bottom: 20px; font-size: 1.1em;">üöÄ Starting payroll risk analysis...</p>
                <div style="width: 100%; max-width: 500px; margin: 0 auto; background: #e9ecef; border-radius: 10px; height: 30px; overflow: hidden; position: relative;">
                    <div id="progress-bar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center;">
                        <span id="progress-percentage" style="color: white; font-weight: 600; font-size: 0.9em;">0%</span>
                    </div>
                </div>
                <p style="color: #999; font-size: 0.9em; margin-top: 15px;">This may take 60-90 seconds. Please wait...</p>
            </div>
            <style>
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            </style>
            <script>
                (function() {
                    const sessionId = "{{ session_id }}";
                    let pollInterval;
                    let pollCount = 0;
                    const maxPolls = 600; // 10 minutes max (1 poll per second)
                    
                    function updateProgress(progress, message) {
                        const progressBar = document.getElementById('progress-bar');
                        const progressPercentage = document.getElementById('progress-percentage');
                        const progressMessage = document.getElementById('progress-message');
                        
                        if (progressBar) {
                            progressBar.style.width = progress + '%';
                        }
                        if (progressPercentage) {
                            progressPercentage.textContent = progress + '%';
                        }
                        if (progressMessage) {
                            progressMessage.textContent = message;
                        }
                    }
                    
                    function pollProgress() {
                        pollCount++;
                        if (pollCount > maxPolls) {
                            clearInterval(pollInterval);
                            updateProgress(0, 'Request timed out. Please refresh the page.');
                            return;
                        }
                        
                        fetch('/payroll-risk/progress')
                            .then(response => response.json())
                            .then(data => {
                                updateProgress(data.progress || 0, data.message || 'Loading...');
                                
                                if (data.status === 'complete') {
                                    clearInterval(pollInterval);
                                    // Reload the page to show results
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 500);
                                } else if (data.status === 'error') {
                                    clearInterval(pollInterval);
                                    updateProgress(0, 'Error: ' + (data.error || 'Unknown error'));
                                    setTimeout(() => {
                                        window.location.href = '/payroll-risk?run=true&async=false';
                                    }, 2000);
                                }
                            })
                            .catch(error => {
                                console.error('Error polling progress:', error);
                            });
                    }
                    
                    // Start polling immediately, then every second
                    pollProgress();
                    pollInterval = setInterval(pollProgress, 1000);
                })();
            </script>
            {% else %}
            <!-- Loading State (synchronous mode) -->
            <div id="loading-indicator" style="margin-top: 30px; text-align: center; padding: 40px;">
                <div class="loading-spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <h3 style="color: #667eea; margin-bottom: 10px;">Analysis in Progress</h3>
                <p style="color: #666; margin-bottom: 5px;">Gathering data from Xero...</p>
                <p style="color: #666; margin-bottom: 5px;">Analyzing payroll risk with AI...</p>
                <p style="color: #999; font-size: 0.9em; margin-top: 20px;">This may take 30-60 seconds. Please wait...</p>
            </div>
            <style>
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            </style>
            <script>
                // Auto-refresh every 3 seconds while loading
                setTimeout(function() {
                    if (document.getElementById('loading-indicator')) {
                        window.location.reload();
                    }
                }, 3000);
            </script>
            {% endif %}
            {% elif not has_result %}
            <div style="margin-top: 30px; text-align: center;">
                <a href="/payroll-risk?run=true" class="btn btn-primary" style="font-size: 1.2em; padding: 15px 30px;">
                    Run Payroll Risk Analysis
                </a>
                <p style="margin-top: 20px; color: #666;">
                    This will analyze your Xero data to assess payroll coverage risk.
                </p>
            </div>
            {% endif %}

            {% if result %}
            <!-- Results Section -->
            <div style="margin-top: 30px;">
                <!-- Status Card -->
                {% set health_value = result.health_status.value if result.health_status.value else 'Red' %}
                <div class="status-card" style="background: {% if health_value == 'Green' %}#d4edda{% elif health_value == 'Yellow' %}#fff3cd{% else %}#f8d7da{% endif %}; 
                    border: 2px solid {% if health_value == 'Green' %}#28a745{% elif health_value == 'Yellow' %}#ffc107{% else %}#dc3545{% endif %}; 
                    border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="font-size: 3em;">
                            {% if health_value == 'Green' %}‚úÖ{% elif health_value == 'Yellow' %}‚ö†Ô∏è{% else %}üî¥{% endif %}
                        </div>
                        <div>
                            <h3 style="margin: 0; color: {% if health_value == 'Green' %}#155724{% elif health_value == 'Yellow' %}#856404{% else %}#721c24{% endif %};">
                                Status: {{ health_value }}
                            </h3>
                            {% if result.near_miss %}
                            <p style="margin: 5px 0 0 0; color: #856404; font-weight: 600;">‚ö†Ô∏è Near Miss - Close to insufficient coverage</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Key Metrics -->
                <div class="summary-stats" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="stat-label">Payroll Date</div>
                        <div class="stat-value" style="font-size: 1.2em;">{{ result.payroll_date[:10] if result.payroll_date else 'N/A' }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Payroll Amount</div>
                        <div class="stat-value">${{ "%.2f"|format(result.payroll_amount_with_buffer) }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Current Cash</div>
                        <div class="stat-value">${{ "%.2f"|format(result.current_cash_available) }}</div>
                    </div>
                    <div class="stat-card stat-card-primary">
                        <div class="stat-label">Coverage Ratio</div>
                        <div class="stat-value">{{ "%.2f"|format(result.payroll_coverage_ratio) }}x</div>
                    </div>
                </div>

                <!-- Advisory Narrative -->
                {% if result.advisory_narrative %}
                <div style="background: #f8f9fa; border-left: 4px solid #667eea; padding: 20px; border-radius: 6px; margin-bottom: 30px;">
                    <h3 style="margin-top: 0; color: #333;">Advisory Summary</h3>
                    <p style="margin: 0; line-height: 1.6; color: #555;">{{ result.advisory_narrative }}</p>
                </div>
                {% endif %}

                <!-- Risk Drivers -->
                {% if result.key_risk_drivers %}
                <div style="margin-bottom: 30px;">
                    <h3>Key Risk Drivers</h3>
                    <ul style="list-style-type: none; padding: 0;">
                        {% for driver in result.key_risk_drivers %}
                        <li style="padding: 10px; margin-bottom: 8px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                            {{ driver }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Recommended Actions -->
                {% if result.recommended_actions %}
                <div style="margin-bottom: 30px;">
                    <h3>Recommended Actions</h3>
                    <ol style="padding-left: 20px;">
                        {% for action in result.recommended_actions %}
                        <li style="padding: 8px 0; color: #333;">{{ action }}</li>
                        {% endfor %}
                    </ol>
                </div>
                {% endif %}

                <!-- Scenarios -->
                {% if result.scenarios %}
                <div style="margin-bottom: 30px;">
                    <h3>Cash Flow Scenarios</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        {% for scenario_name, scenario in result.scenarios.items() %}
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #dee2e6;">
                            <div style="font-weight: 600; color: #667eea; margin-bottom: 10px; text-transform: capitalize;">
                                {{ scenario_name }}
                            </div>
                            <div style="font-size: 1.5em; font-weight: 700; color: #333;">
                                ${{ "%.2f"|format(scenario.projected_cash) }}
                            </div>
                            <div style="color: #666; font-size: 0.9em; margin-top: 5px;">
                                Coverage: {{ "%.2f"|format(scenario.coverage_ratio) }}x
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Technical Details (Collapsible) -->
                <details style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #667eea;">Technical Details</summary>
                    <div style="margin-top: 15px;">
                        <p><strong>Detection Tier:</strong> {{ result.detection_tier }} ({{ result.detection_confidence }} confidence)</p>
                        <p><strong>Forecast Confidence:</strong> {{ result.forecast_confidence }}%</p>
                        <p><strong>Data Completeness:</strong> {{ result.data_completeness_score }}%</p>
                        {% if result.assumptions %}
                        <div style="margin-top: 15px;">
                            <strong>Assumptions:</strong>
                            <ul style="margin-top: 5px;">
                                {% for assumption in result.assumptions %}
                                <li style="color: #666;">{{ assumption }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        {% if result.warnings %}
                        <div style="margin-top: 15px;">
                            <strong>Warnings:</strong>
                            <ul style="margin-top: 5px;">
                                {% for warning in result.warnings %}
                                <li style="color: #856404;">{{ warning }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        <div style="margin-top: 15px;">
                            <strong>JSON Data:</strong>
                            <pre style="background: white; padding: 15px; border-radius: 4px; overflow-x: auto; max-height: 400px; font-size: 0.85em;">{{ result.to_dict()|tojson }}</pre>
                        </div>
                    </div>
                </details>

                <!-- Re-run Button -->
                <div style="margin-top: 30px; text-align: center;">
                    <a href="/payroll-risk?run=true" class="btn btn-primary">Refresh Analysis</a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <script src="/static/js/main.js"></script>
</body>
</html>

