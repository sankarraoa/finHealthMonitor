{% extends "base.html" %}

{% block title %}Payroll Risk - FinHealthMonitor{% endblock %}

{% block extra_css %}
<style>
    .payroll-risk-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    
    .view-icon {
        color: #667eea;
        font-size: 1.2em;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .view-icon:hover {
        color: #5568d3;
    }
    
    .view-icon i {
        font-size: inherit;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 30px;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close:hover {
        color: #000;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 10px;
        height: 19px;
        font-family: 'Nunito Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        font-style: normal;
        font-size: 14px;
        line-height: 19px;
        color: #606060;
    }
    
    .form-group select,
    .form-group input[type="text"],
    .form-group input[type="email"],
    .form-group input[type="number"],
    .form-group input[type="date"],
    .form-group textarea {
        width: 100%;
        box-sizing: border-box;
        height: 50px;
        padding: 0 12px;
        background: #F5F6FA;
        border: 0.6px solid #D5D5D5;
        border-radius: 4px;
        font-family: 'Nunito Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        font-style: normal;
        font-weight: 500;
        font-size: 14px;
        line-height: 19px;
        color: #202224;
        min-height: 50px;

    }
    
    .form-group textarea {
        height: auto;
        min-height: 50px;
        padding: 12px;
        resize: vertical;
    }
    
    .progress-container {
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .progress-bar {
        width: 100%;
        height: 30px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 10px;
    }
    
    .progress-fill {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        height: 100%;
        width: 0%;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
    }
    
    .analysis-info-label {
        font-family: 'Nunito Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        font-style: normal;
        font-weight: 400;
        font-size: 16px;
        line-height: 22px;
        color: #404040;
        margin-bottom: 8px;
    }
    
    .analysis-info-value {
        font-family: 'Nunito Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        font-style: normal;
        font-weight: 600;
        font-size: 16px;
        line-height: 22px;
        color: #404040;
    }
</style>
{% endblock %}

{% block content %}
<div class="content-section">
    {% if view_mode == "list" %}
        <!-- List View -->
        <div class="payroll-risk-header">
            <h2>Payroll Risk Early Warning</h2>
            <button class="btn btn-primary" onclick="openNewAnalysisModal()">+ New Analysis</button>
        </div>
        
        <p>Payroll Risk Early Warning helps you identify potential cash flow issues before payroll dates. The system analyzes your current cash position, upcoming payroll obligations, and projected cash flow to provide early warnings and actionable recommendations.</p>
        
        {% if error %}
        <div style="background: #f8d7da; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
            <p><strong>Error:</strong> {{ error }}</p>
        </div>
        {% endif %}
        
        {% if analyses %}
        <table class="analyses-table">
            <thead>
                <tr>
                    <th>Date & Time</th>
                    <th>Connection</th>
                    <th>Tenant</th>
                    <th>Status</th>
                    <th>Progress</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for analysis in analyses %}
                <tr onclick="window.location.href='/payroll-risk/{{ analysis.id }}'">
                    <td>{{ analysis.initiated_at[:19].replace('T', ' ') }}</td>
                    <td class="row-text-bold">{{ analysis.connection_name }}</td>
                    <td>{{ analysis.tenant_name or '-' }}</td>
                    <td>
                        <span class="status-badge status-{{ analysis.status|lower }}">
                            <span>{{ analysis.status }}</span>
                        </span>
                    </td>
                    <td>
                        {% if analysis.status|lower == "running" %}
                            {{ analysis.progress or 0 }}%
                        {% elif analysis.status|lower == "completed" %}
                            100%
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        <a href="/payroll-risk/{{ analysis.id }}" class="view-icon" onclick="event.stopPropagation();">
                            <i class="las la-eye"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <!-- Pagination Control -->
        <div class="pagination-control">
            <button id="prevPage" onclick="navigatePage(-1)" disabled>
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <button id="nextPage" onclick="navigatePage(1)">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
        {% else %}
        <div style="text-align: center; padding: 60px 20px;">
            <p>No payroll risk analyses yet.</p>
            <button class="btn btn-primary" onclick="openNewAnalysisModal()">Start Your First Analysis</button>
        </div>
        {% endif %}
        
        <!-- New Analysis Modal -->
        <div id="newAnalysisModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Start New Payroll Risk Analysis</h3>
                    <span class="close" onclick="closeNewAnalysisModal()">&times;</span>
                </div>
                <form action="/payroll-risk/new" method="POST" id="newAnalysisForm">
                    <div class="form-group">
                        <label for="connection_id">Connection *</label>
                        <select name="connection_id" id="connection_id" required onchange="updateTenantSelector()">
                            <option value="">Select a connection...</option>
                            {% if connections %}
                                {% for conn in connections %}
                                    {% if conn.software == "xero" %}
                                    <option value="{{ conn.id }}" data-software="{{ conn.software }}">
                                        {{ conn.name }}
                                    </option>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="form-group" id="tenantGroup" style="display: none;">
                        <label for="tenant_id">Tenant</label>
                        <select name="tenant_id" id="tenant_id">
                            <option value="">Select a tenant...</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                        <button type="button" class="btn btn-secondary" onclick="closeNewAnalysisModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Start Analysis</button>
                    </div>
                </form>
            </div>
        </div>
        
    {% elif view_mode == "details" %}
        <!-- Details View -->
        <div style="margin-bottom: 20px;">
            <a href="/payroll-risk" style="color: #667eea; text-decoration: none;">← Back to List</a>
        </div>
        
        <h2>Payroll Risk Analysis Details</h2>
        
        <!-- Analysis Info -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <div>
                    <div class="analysis-info-label">Connection</div>
                    <div class="analysis-info-value">{{ analysis.connection_name }}</div>
                </div>
                <div>
                    <div class="analysis-info-label">Tenant</div>
                    <div class="analysis-info-value">{{ analysis.tenant_name or 'N/A' }}</div>
                </div>
                <div>
                    <div class="analysis-info-label">Initiated</div>
                    <div class="analysis-info-value" data-date="{{ analysis.initiated_at or '' }}">
                        {% if analysis.initiated_at %}
                            {{ analysis.initiated_at[:19].replace('T', ' ') }}
                        {% else %}
                            N/A
                        {% endif %}
                    </div>
                </div>
                {% if analysis.completed_at %}
                <div>
                    <div class="analysis-info-label">Completed</div>
                    <div class="analysis-info-value" data-date="{{ analysis.completed_at or '' }}">
                        {{ analysis.completed_at[:19].replace('T', ' ') }}
                    </div>
                </div>
                {% endif %}
                <div>
                    <div class="analysis-info-label">Status</div>
                    <div>
                        <span class="status-badge status-{{ analysis.status|lower }}">
                            <span>{{ analysis.status }}</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        {% if analysis.status == "running" %}
            <!-- Progress View -->
            <div class="progress-container">
                <h3>Analysis in Progress</h3>
                <p id="progress-message">{{ analysis.progress_message or "Initializing..." }}</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: {{ analysis.progress or 0 }}%;">
                        {{ analysis.progress or 0 }}%
                    </div>
                </div>
                <p>This may take 60-90 seconds. You can navigate away and come back later.</p>
            </div>
            
            <script>
                (function() {
                    const analysisId = "{{ analysis.id }}";
                    let pollInterval;
                    let pollCount = 0;
                    const maxPolls = 600; // 10 minutes max
                    
                    function updateProgress(progress, message) {
                        const progressFill = document.getElementById('progress-fill');
                        const progressMessage = document.getElementById('progress-message');
                        
                        if (progressFill) {
                            progressFill.style.width = progress + '%';
                            progressFill.textContent = progress + '%';
                        }
                        if (progressMessage) {
                            progressMessage.textContent = message;
                        }
                    }
                    
                    function pollProgress() {
                        pollCount++;
                        if (pollCount > maxPolls) {
                            clearInterval(pollInterval);
                            updateProgress(0, 'Request timed out. Please refresh the page.');
                            return;
                        }
                        
                        fetch(`/payroll-risk/${analysisId}/progress`)
                            .then(response => response.json())
                            .then(data => {
                                updateProgress(data.progress || 0, data.message || 'Loading...');
                                
                                const status = (data.status || '').toLowerCase();
                                
                                if (status === 'completed' || status === 'complete') {
                                    clearInterval(pollInterval);
                                    // Reload immediately to show results
                                    window.location.reload();
                                } else if (status === 'failed' || status === 'error') {
                                    clearInterval(pollInterval);
                                    updateProgress(0, 'Error: ' + (data.error || 'Unknown error'));
                                }
                            })
                            .catch(error => {
                                console.error('Error polling progress:', error);
                            });
                    }
                    
                    pollProgress();
                    pollInterval = setInterval(pollProgress, 1000);
                })();
            </script>
        
        {% elif analysis.status|lower == "failed" %}
            <!-- Error View -->
            <div style="background: #f8d7da; padding: 20px; border-radius: 8px;">
                <h3>Analysis Failed</h3>
                <p><strong>Error:</strong> {{ analysis.error_message or "Unknown error" }}</p>
            </div>
        
        {% elif analysis.status|lower == "completed" and analysis.result_data %}
            <!-- Results View -->
            {% set result = analysis.result_data %}
            
            <!-- Risk Level Card -->
            {% set health_value = result.health_status if result.health_status else 'Red' %}
            {% set risk_class = 'risk-green' if health_value == 'Green' else ('risk-yellow' if health_value == 'Yellow' else 'risk-red') %}
            <div class="risk-level-card {{ risk_class }}">
                <div class="risk-level-indicator">
                    {% if health_value == 'Green' %}✓{% elif health_value == 'Yellow' %}⚠{% else %}✕{% endif %}
                </div>
                <div class="risk-level-content">
                    <div class="risk-level-label">Risk Level</div>
                    <div class="risk-level-value">{{ health_value }}</div>
                    {% if result.near_miss %}
                    <div class="risk-level-near-miss">⚠️ Near Miss - Close to insufficient coverage</div>
                    {% endif %}
                </div>
            </div>

            <!-- Key Metrics -->
            <div class="summary-stats" style="margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-label">Payroll Date</div>
                    <div class="stat-value">{{ result.payroll_date[:10] if result.payroll_date else 'N/A' }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Payroll Amount</div>
                    <div class="stat-value">${{ "%.2f"|format(result.payroll_amount_with_buffer) if result.payroll_amount_with_buffer else '0.00' }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Current Cash</div>
                    <div class="stat-value">${{ "%.2f"|format(result.current_cash_available) if result.current_cash_available else '0.00' }}</div>
                </div>
                <div class="stat-card stat-card-primary">
                    <div class="stat-label">Coverage Ratio</div>
                    <div class="stat-value">{{ "%.2f"|format(result.payroll_coverage_ratio) if result.payroll_coverage_ratio else '0.00' }}x</div>
                </div>
            </div>

            <!-- Advisory Narrative -->
            {% if result.advisory_narrative %}
            <div style="background: #f8f9fa; border-left: 4px solid #667eea; padding: 20px; border-radius: 6px; margin-bottom: 30px;">
                <h3>Advisory Summary</h3>
                <p>{{ result.advisory_narrative }}</p>
            </div>
            {% endif %}

            <!-- Risk Drivers -->
            {% if result.key_risk_drivers %}
            <div style="margin-bottom: 30px;">
                <h3>Key Risk Drivers</h3>
                <ul style="list-style-type: none; padding: 0;">
                    {% for driver in result.key_risk_drivers %}
                    <li style="padding: 10px; margin-bottom: 8px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                        <p>{{ driver }}</p>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Recommended Actions -->
            {% if result.recommended_actions %}
            <div style="margin-bottom: 30px;">
                <h3>Recommended Actions</h3>
                <ol style="padding-left: 20px;">
                    {% for action in result.recommended_actions %}
                    <li style="padding: 8px 0;">
                        <p>{{ action }}</p>
                    </li>
                    {% endfor %}
                </ol>
            </div>
            {% endif %}

            <!-- Scenarios -->
            {% if result.scenarios %}
            <div style="margin-bottom: 30px;">
                <h3>Cash Flow Scenarios</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    {% for scenario_name, scenario in result.scenarios.items() %}
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #dee2e6;">
                        <div class="analysis-info-label" style="text-transform: capitalize; margin-bottom: 10px;">
                            {{ scenario_name }}
                        </div>
                        <div class="analysis-info-value" style="font-size: 1.5em; margin-bottom: 5px;">
                            ${{ "%.2f"|format(scenario.projected_cash) if scenario.projected_cash else '0.00' }}
                        </div>
                        <p>
                            Coverage: {{ "%.2f"|format(scenario.coverage_ratio) if scenario.coverage_ratio else '0.00' }}x
                        </p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Technical Details (Collapsible) -->
            <details style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                <summary style="cursor: pointer;">Technical Details</summary>
                <div style="margin-top: 15px;">
                    <p><strong>Detection Tier:</strong> {{ result.detection_tier if result.detection_tier else 'N/A' }} ({{ result.detection_confidence if result.detection_confidence else 'N/A' }} confidence)</p>
                    <p><strong>Forecast Confidence:</strong> {{ result.forecast_confidence if result.forecast_confidence else 'N/A' }}%</p>
                    <p><strong>Data Completeness:</strong> {{ result.data_completeness_score if result.data_completeness_score else 'N/A' }}%</p>
                    {% if result.assumptions %}
                    <div style="margin-top: 15px;">
                        <p><strong>Assumptions:</strong></p>
                        <ul style="margin-top: 5px; padding-left: 20px;">
                            {% for assumption in result.assumptions %}
                            <li>
                                <p>{{ assumption }}</p>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    {% if result.warnings %}
                    <div style="margin-top: 15px;">
                        <p><strong>Warnings:</strong></p>
                        <ul style="margin-top: 5px; padding-left: 20px;">
                            {% for warning in result.warnings %}
                            <li>
                                <p>{{ warning }}</p>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </details>
        {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Modal functions
    function openNewAnalysisModal() {
        document.getElementById('newAnalysisModal').style.display = 'block';
    }
    
    function closeNewAnalysisModal() {
        document.getElementById('newAnalysisModal').style.display = 'none';
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('newAnalysisModal');
        if (event.target == modal) {
            closeNewAnalysisModal();
        }
    }
    
    // Update tenant selector based on connection
    function updateTenantSelector() {
        const connectionSelect = document.getElementById('connection_id');
        const tenantGroup = document.getElementById('tenantGroup');
        const tenantSelect = document.getElementById('tenant_id');
        
        const selectedOption = connectionSelect.options[connectionSelect.selectedIndex];
        const connectionId = connectionSelect.value;
        
        if (!connectionId) {
            tenantGroup.style.display = 'none';
            return;
        }
        
        // Fetch tenants for this connection
        fetch(`/api/connections/${connectionId}/tenants`)
            .then(response => response.json())
            .then(data => {
                tenantSelect.innerHTML = '<option value="">Select a tenant...</option>';
                
                if (data.tenants && data.tenants.length > 0) {
                    tenantGroup.style.display = 'block';
                    data.tenants.forEach(tenant => {
                        const option = document.createElement('option');
                        option.value = tenant.tenant_id;
                        option.textContent = tenant.tenant_name;
                        tenantSelect.appendChild(option);
                    });
                } else {
                    tenantGroup.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error fetching tenants:', error);
                tenantGroup.style.display = 'none';
            });
    }
    
    // Pagination functionality
    let currentPage = 1;
    const rowsPerPage = 10;
    
    function navigatePage(direction) {
        const table = document.querySelector('.analyses-table');
        if (!table) return;
        
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        const totalPages = Math.ceil(rows.length / rowsPerPage);
        
        currentPage += direction;
        
        if (currentPage < 1) currentPage = 1;
        if (currentPage > totalPages) currentPage = totalPages;
        
        // Hide all rows
        rows.forEach(row => row.style.display = 'none');
        
        // Show rows for current page
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        rows.slice(start, end).forEach(row => row.style.display = '');
        
        // Update button states
        const prevBtn = document.getElementById('prevPage');
        const nextBtn = document.getElementById('nextPage');
        
        if (prevBtn) prevBtn.disabled = currentPage === 1;
        if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
    }
    
    // Initialize pagination on page load
    document.addEventListener('DOMContentLoaded', function() {
        const table = document.querySelector('.analyses-table');
        if (table) {
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            if (rows.length > rowsPerPage) {
                navigatePage(0); // Initialize to show first page
            } else {
                // Hide pagination if not needed
                const pagination = document.querySelector('.pagination-control');
                if (pagination) pagination.style.display = 'none';
            }
        }
        
        // Format dates in analysis info
        function formatDate(dateStr) {
            if (!dateStr || dateStr === 'N/A') return 'N/A';
            
            try {
                const date = new Date(dateStr);
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const day = String(date.getDate()).padStart(2, '0');
                const month = months[date.getMonth()];
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${day}-${month}-${year} ${hours}:${minutes}`;
            } catch (e) {
                return dateStr;
            }
        }
        
        // Apply date formatting to all analysis-info-value elements with data-date attribute
        document.querySelectorAll('.analysis-info-value[data-date]').forEach(function(el) {
            const dateStr = el.getAttribute('data-date');
            if (dateStr) {
                el.textContent = formatDate(dateStr);
            }
        });
    });
</script>
{% endblock %}
