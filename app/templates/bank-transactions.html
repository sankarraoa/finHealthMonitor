{% extends "base.html" %}

{% block title %}Bank Transactions - FinHealthMonitor{% endblock %}

{% block extra_css %}{% endblock %}

{% block content %}
        <div class="content-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2>Bank Transactions (Bank Feeds)</h2>
                <div style="display: flex; align-items: center; gap: 10px;">
                    {% include "_connection_selector.html" %}
                    {% if selected_connection and selected_connection.software == "xero" %}
                        {% include "_tenant_selector.html" %}
                    {% endif %}
                </div>
            </div>
            
            {% if error %}
            <div class="error-message" style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                <strong>Error:</strong> {{ error }}
            </div>
            {% endif %}

            {% if async_mode and not transactions %}
            <!-- Loading State with Skeleton Table -->
            <div id="loading-container">
                <p id="loading-message" style="margin-bottom: 20px;">Fetching bank transactions from {{ selected_connection.software|title if selected_connection else 'connection' }}...</p>
                
                <!-- Skeleton Table -->
                <table class="skeleton-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Contact</th>
                            <th>Reference</th>
                            <th>Total Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for i in range(10) %}
                        <tr>
                            <td class="skeleton-cell">
                                <div class="skeleton-bar short"></div>
                            </td>
                            <td class="skeleton-cell">
                                <div class="skeleton-bar short"></div>
                            </td>
                            <td class="skeleton-cell">
                                <div class="skeleton-bar medium"></div>
                            </td>
                            <td class="skeleton-cell">
                                <div class="skeleton-bar short"></div>
                            </td>
                            <td class="skeleton-cell">
                                <div class="skeleton-bar short"></div>
                            </td>
                            <td class="skeleton-cell">
                                <div class="skeleton-badge"></div>
                            </td>
                            <td class="skeleton-cell">
                                <div class="skeleton-bar short"></div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                <!-- Progress Bar -->
                <div class="progress-container" style="margin-top: 20px;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-bar" style="width: 0%;">
                            <span id="progress-percentage">0%</span>
                        </div>
                    </div>
                    <p id="progress-message" style="margin-top: 10px; text-align: center;">Initializing...</p>
                </div>
            </div>
            <script>
                (function() {
                    const sessionId = "{{ session_id }}";
                    let pollInterval;
                    let pollCount = 0;
                    const maxPolls = 300;
                    
                    function updateProgress(progress, message) {
                        const progressBar = document.getElementById('progress-bar');
                        const progressPercentage = document.getElementById('progress-percentage');
                        const progressMessage = document.getElementById('progress-message');
                        
                        if (progressBar) {
                            progressBar.style.width = progress + '%';
                            const percentageSpan = progressBar.querySelector('#progress-percentage');
                            if (percentageSpan) percentageSpan.textContent = progress + '%';
                        }
                        if (progressMessage) progressMessage.textContent = message;
                    }
                    
                    function pollProgress() {
                        pollCount++;
                        if (pollCount > maxPolls) {
                            clearInterval(pollInterval);
                            updateProgress(0, 'Request timed out. Please refresh the page.');
                            return;
                        }
                        
                        fetch('/bank-transactions/progress')
                            .then(response => response.json())
                            .then(data => {
                                updateProgress(data.progress || 0, data.message || 'Loading...');
                                
                                if (data.status === 'complete') {
                                    clearInterval(pollInterval);
                                    setTimeout(() => window.location.reload(), 500);
                                } else if (data.status === 'error') {
                                    clearInterval(pollInterval);
                                    updateProgress(0, 'Error: ' + (data.error || 'Unknown error'));
                                    setTimeout(() => window.location.href = '/bank-transactions?async=false', 2000);
                                }
                            })
                            .catch(error => console.error('Error polling progress:', error));
                    }
                    
                    pollProgress();
                    pollInterval = setInterval(pollProgress, 1000);
                })();
            </script>
            {% elif transactions %}
            <table class="accounts-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Contact</th>
                        <th>Reference</th>
                        <th>Total Amount</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in transactions %}
                    <tr>
                        <td>{{ transaction.date or 'N/A' }}</td>
                        <td class="row-text-bold">{{ transaction.type or 'N/A' }}</td>
                        <td>{{ transaction.contact or 'N/A' }}</td>
                        <td>{{ transaction.reference or 'N/A' }}</td>
                        <td>
                            <span class="{% if transaction.total >= 0 %}amount-positive{% else %}amount-negative{% endif %}">
                                ${{ "%.2f"|format(transaction.total) }}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge status-{{ transaction.status|lower|replace(' ', '-') }}">
                                <span>{{ transaction.status or 'N/A' }}</span>
                            </span>
                        </td>
                        <td>
                            <button class="expand-btn" onclick="toggleDetails(this, 'transaction-{{ loop.index }}')">
                                <span class="expand-text">Show Details</span>
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="7" style="padding: 0;">
                            <div id="transaction-{{ loop.index }}" class="transaction-details">
                                <h4>Transaction Details</h4>
                                <p><strong>Transaction ID:</strong> {{ transaction.id or 'N/A' }}</p>
                                {% if transaction.line_items %}
                                <h5>Line Items:</h5>
                                <table class="items-table">
                                    <thead>
                                        <tr>
                                            <th>Description</th>
                                            <th>Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in transaction.line_items %}
                                        <tr>
                                            <td>{{ item.description or 'N/A' }}</td>
                                            <td>
                                                <span class="{% if item.amount >= 0 %}amount-positive{% else %}amount-negative{% endif %}">
                                                    ${{ "%.2f"|format(item.amount) }}
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                {% else %}
                                <p>No line items available</p>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- Pagination Control -->
            <div class="pagination-control">
                <button id="prevPage" onclick="navigatePage(-1)" disabled>
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button id="nextPage" onclick="navigatePage(1)">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            {% else %}
            <div style="background: #e9ecef; padding: 20px; border-radius: 6px; text-align: center;">
                <p>No bank transactions found.</p>
            </div>
            {% endif %}

            <div style="margin-top: 30px;">
                <a href="/bank-transactions" class="btn btn-primary">Refresh</a>
                <a href="/home" class="btn btn-secondary">Back to Home</a>
            </div>
        </div>

    <script>
        function toggleDetails(button, id) {
            const details = document.getElementById(id);
            if (!details) {
                console.error('Details element not found:', id);
                return;
            }
            
            const text = button.querySelector('.expand-text');
            
            if (details.classList.contains('show')) {
                details.classList.remove('show');
                if (text) text.textContent = 'Show Details';
            } else {
                details.classList.add('show');
                if (text) text.textContent = 'Hide Details';
            }
        }
        
        // Pagination functionality
        let currentPage = 1;
        const rowsPerPage = 10;
        
        function navigatePage(direction) {
            const table = document.querySelector('.accounts-table');
            if (!table) return;
            
            const rows = Array.from(table.querySelectorAll('tbody tr:not([colspan])'));
            const totalPages = Math.ceil(rows.length / rowsPerPage);
            
            currentPage += direction;
            
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            
            // Hide all rows and their detail rows
            table.querySelectorAll('tbody tr').forEach(row => row.style.display = 'none');
            
            // Show rows for current page
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            rows.slice(start, end).forEach((row, index) => {
                row.style.display = '';
                // Show detail row if it exists and is expanded
                const detailRow = row.nextElementSibling;
                if (detailRow && detailRow.querySelector('.transaction-details.show')) {
                    detailRow.style.display = '';
                }
            });
            
            // Update button states
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            
            if (prevBtn) prevBtn.disabled = currentPage === 1;
            if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
        }
        
        // Initialize pagination on page load
        document.addEventListener('DOMContentLoaded', function() {
            const table = document.querySelector('.accounts-table');
            if (table) {
                const rows = Array.from(table.querySelectorAll('tbody tr:not([colspan])'));
                if (rows.length > rowsPerPage) {
                    navigatePage(0); // Initialize to show first page
                } else {
                    // Hide pagination if not needed
                    const pagination = document.querySelector('.pagination-control');
                    if (pagination) pagination.style.display = 'none';
                }
            }
        });
    </script>
{% endblock %}
