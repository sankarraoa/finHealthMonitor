{% extends "base.html" %}

{% block title %}Users - Security - FinHealthMonitor{% endblock %}

{% block content %}
<div class="content-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div>
            <h2>Users</h2>
            <p style="margin-top: 8px; color: #606060;">Manage users in your organization</p>
        </div>
        <button class="btn btn-primary" onclick="showAddUserModal()" style="width: auto; height: auto; padding: 10px 20px;">
            <i class="las la-plus-circle" style="margin-right: 8px;"></i> Add User
        </button>
    </div>

    {% if error %}
    <div style="background: #f8d7da; padding: 15px; border-radius: 6px; margin-bottom: 20px; color: #721c24;">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

    {% if success %}
    <div style="background: #d4edda; padding: 15px; border-radius: 6px; margin-bottom: 20px; color: #155724;">
        <strong>Success:</strong> {{ success }}
    </div>
    {% endif %}

    <div id="users-table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="users-table-body">
                <tr>
                    <td colspan="4" style="text-align: center; padding: 40px;">
                        <div style="color: #606060;">Loading users...</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Edit User Modal -->
<div id="userModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="userModalTitle">Add New User</h3>
            <span class="close" onclick="closeUserModal()">&times;</span>
        </div>
        <form id="userForm">
            <input type="hidden" id="userId" name="user_id" />
            <div class="form-group">
                <label for="userEmail">Email Address *</label>
                <input type="email" id="userEmail" name="email" required 
                       placeholder="user@example.com" {% if edit_mode %}readonly style="background: #f5f5f5;"{% endif %} />
                {% if edit_mode %}
                <small style="color: #606060; display: block; margin-top: 4px;">Email cannot be changed</small>
                {% endif %}
            </div>
            <div class="form-group">
                <label for="userFirstName">First Name *</label>
                <input type="text" id="userFirstName" name="first_name" required placeholder="John" />
            </div>
            <div class="form-group">
                <label for="userLastName">Last Name *</label>
                <input type="text" id="userLastName" name="last_name" required placeholder="Doe" />
            </div>
            <div class="form-group">
                <label for="userImageFile">Profile Image</label>
                <input type="file" id="userImageFile" name="image_file" accept="image/*" />
                <small style="color: #606060; display: block; margin-top: 4px;">Upload a profile image (JPG, PNG, etc.)</small>
                <div id="imagePreview" style="margin-top: 10px; display: none;">
                    <img id="previewImg" src="" alt="Preview" style="max-width: 150px; max-height: 150px; border-radius: 8px; border: 1px solid #E0E0E0;" />
                </div>
            </div>
            <div class="form-group">
                <label for="userRole">Role *</label>
                <select id="userRole" name="userRole" required style="width: 100%; padding: 10px 12px; border: 1px solid #E0E0E0; border-radius: 6px; font-size: 14px; background: white;">
                    <option value="">Loading roles...</option>
                </select>
                <small style="color: #606060; display: block; margin-top: 4px;">Select one role for this user</small>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                <button type="button" onclick="closeUserModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary" id="userFormSubmit">Add User</button>
            </div>
        </form>
    </div>
</div>

<script>
let currentTenantId = null;
let editingUserId = null;

// Load current tenant from session or API
async function loadCurrentTenant() {
    try {
        const response = await fetch('/api/auth/me');
        if (response.ok) {
            const data = await response.json();
            // Get tenant from session or use first tenant
            // For now, we'll get it from the API response or use a default
            return data.tenant_id || null;
        }
    } catch (error) {
        console.error('Error loading tenant:', error);
    }
    return null;
}

// Load users
async function loadUsers() {
    if (!currentTenantId) {
        currentTenantId = await loadCurrentTenant();
        if (!currentTenantId) {
            // Get first tenant from list
            try {
                const response = await fetch('/api/tenants');
                if (response.ok) {
                    const tenants = await response.json();
                    if (tenants.length > 0) {
                        currentTenantId = tenants[0].id;
                    }
                }
            } catch (error) {
                console.error('Error loading tenants:', error);
            }
        }
    }

    if (!currentTenantId) {
        document.getElementById('users-table-body').innerHTML = 
            '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #dc3545;">No tenant found. Please contact administrator.</td></tr>';
        return;
    }

    try {
        const response = await fetch(`/api/tenants/${currentTenantId}/users`);
        if (!response.ok) {
            throw new Error('Failed to load users');
        }
        const users = await response.json();
        displayUsers(users);
    } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('users-table-body').innerHTML = 
            '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #dc3545;">Error loading users: ' + error.message + '</td></tr>';
    }
}

// Display users in table
function displayUsers(users) {
    const tbody = document.getElementById('users-table-body');
    if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #606060;">No users found. Click "Add User" to create one.</td></tr>';
        return;
    }

    tbody.innerHTML = users.map(user => {
        const roles = user.roles || [];
        const rolesText = roles.length > 0 ? roles.map(r => r.name).join(', ') : 'No roles assigned';
        const statusBadge = user.is_active 
            ? '<span class="status-badge status-completed">Active</span>'
            : '<span class="status-badge status-failed">Inactive</span>';
        
        // Get user image or use initials as fallback
        let imageHtml = '';
        if (user.image_url) {
            imageHtml = `<img src="${escapeHtml(user.image_url)}" alt="${escapeHtml(user.first_name)} ${escapeHtml(user.last_name)}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #E0E0E0;" />`;
        } else {
            // Generate initials
            const initials = (user.first_name?.[0] || '') + (user.last_name?.[0] || '');
            imageHtml = `<div style="width: 40px; height: 40px; border-radius: 50%; background: #4A90E2; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; border: 2px solid #E0E0E0;">${escapeHtml(initials)}</div>`;
        }
        
        return `
            <tr>
                <td>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="flex-shrink: 0;">
                            ${imageHtml}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; color: #1a1a1a; margin-bottom: 4px;">${escapeHtml(user.first_name)} ${escapeHtml(user.last_name)}</div>
                            <div style="font-size: 13px; color: #606060;">${escapeHtml(rolesText)}</div>
                        </div>
                    </div>
                </td>
                <td>${escapeHtml(user.email)}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="icon-action-link" onclick="editUser('${user.id}')" title="Edit">
                        <i class="las la-edit"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Load roles for selection
async function loadRolesForSelection() {
    if (!currentTenantId) {
        await loadCurrentTenant();
    }
    
    if (!currentTenantId) {
        document.getElementById('rolesContainer').innerHTML = '<div style="color: #dc3545; text-align: center; padding: 20px;">No tenant found</div>';
        return [];
    }
    
    try {
        const response = await fetch(`/api/tenants/${currentTenantId}/roles`);
        if (!response.ok) {
            throw new Error('Failed to load roles');
        }
        const roles = await response.json();
        return roles;
    } catch (error) {
        console.error('Error loading roles:', error);
        document.getElementById('rolesContainer').innerHTML = '<div style="color: #dc3545; text-align: center; padding: 20px;">Error loading roles</div>';
        return [];
    }
}

// Display roles as dropdown (single selection)
function displayRolesForSelection(roles, selectedRoleId = null) {
    const select = document.getElementById('userRole');
    
    if (roles.length === 0) {
        select.innerHTML = '<option value="">No roles available</option>';
        select.disabled = true;
        return;
    }
    
    select.disabled = false;
    let html = '<option value="">Select a role...</option>';
    roles.forEach(role => {
        const selected = selectedRoleId === role.id ? 'selected' : '';
        const displayText = role.description 
            ? `${escapeHtml(role.name)} - ${escapeHtml(role.description)}`
            : escapeHtml(role.name);
        html += `<option value="${role.id}" ${selected}>${displayText}</option>`;
    });
    
    select.innerHTML = html;
}

// Show add user modal
async function showAddUserModal() {
    editingUserId = null;
    document.getElementById('userModalTitle').textContent = 'Add New User';
    document.getElementById('userFormSubmit').textContent = 'Add User';
    document.getElementById('userId').value = '';
    document.getElementById('userForm').reset();
    document.getElementById('userEmail').removeAttribute('readonly');
    document.getElementById('userEmail').style.background = '';
    document.getElementById('imagePreview').style.display = 'none';
    
    // Load and display roles
    const roles = await loadRolesForSelection();
    displayRolesForSelection(roles, null);
    
    document.getElementById('userModal').style.display = 'block';
}

// Preview image when file is selected
document.getElementById('userImageFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        // Validate file size (max 2MB)
        if (file.size > 2 * 1024 * 1024) {
            alert('Image file is too large. Please use an image smaller than 2MB.');
            e.target.value = ''; // Clear the input
            document.getElementById('imagePreview').style.display = 'none';
            return;
        }
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file.');
            e.target.value = ''; // Clear the input
            document.getElementById('imagePreview').style.display = 'none';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewImg').src = e.target.result;
            document.getElementById('imagePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        document.getElementById('imagePreview').style.display = 'none';
    }
});

// Edit user
async function editUser(userId) {
    editingUserId = userId;
    try {
        // Get user details
        const userResponse = await fetch(`/api/tenants/${currentTenantId}/users/${userId}`);
        if (!userResponse.ok) {
            throw new Error('Failed to load user details');
        }
        const user = await userResponse.json();
        
        // Get user's roles - take the first one (or null if none)
        const rolesResponse = await fetch(`/api/tenants/${currentTenantId}/users/${userId}/roles`);
        const userRoles = rolesResponse.ok ? await rolesResponse.json() : [];
        const selectedRoleId = userRoles.length > 0 ? userRoles[0].id : null;
        
        document.getElementById('userModalTitle').textContent = 'Edit User';
        document.getElementById('userFormSubmit').textContent = 'Update User';
        document.getElementById('userId').value = user.id;
        document.getElementById('userEmail').value = user.email;
        document.getElementById('userEmail').setAttribute('readonly', 'readonly');
        document.getElementById('userEmail').style.background = '#f5f5f5';
        document.getElementById('userFirstName').value = user.first_name;
        document.getElementById('userLastName').value = user.last_name;
        document.getElementById('userImageFile').value = '';
        document.getElementById('imagePreview').style.display = 'none';
        if (user.image_url) {
            document.getElementById('previewImg').src = user.image_url;
            document.getElementById('imagePreview').style.display = 'block';
        }
        
        // Load and display roles with current selection (first role only)
        const roles = await loadRolesForSelection();
        displayRolesForSelection(roles, selectedRoleId);
        
        document.getElementById('userModal').style.display = 'block';
    } catch (error) {
        alert('Error loading user: ' + error.message);
    }
}

// Close modal
function closeUserModal() {
    document.getElementById('userModal').style.display = 'none';
    editingUserId = null;
}

// Handle form submission
document.getElementById('userForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const imageFile = document.getElementById('userImageFile').files[0];
    
    // Get selected role (single selection)
    const selectedRoleId = formData.get('userRole');
    if (!selectedRoleId) {
        alert('Please select a role for the user');
        return;
    }
    
    // Convert uploaded image to base64 data URL for storage in database
    // Images are optimized client-side and stored as base64 (suitable for small avatars)
    let imageUrl = null;
    if (imageFile) {
        // Validate file size (max 2MB before compression)
        if (imageFile.size > 2 * 1024 * 1024) {
            alert('Image file is too large. Please use an image smaller than 2MB.');
            return;
        }
        
        try {
            imageUrl = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const dataUrl = e.target.result;
                    // Validate that it's a proper data URL
                    if (dataUrl && dataUrl.startsWith('data:image/')) {
                        resolve(dataUrl);
                    } else {
                        reject(new Error('Invalid image format'));
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read image file'));
                reader.readAsDataURL(imageFile);
            });
        } catch (error) {
            alert(`Error processing image: ${error.message}`);
            return;
        }
    }
    
    try {
        let response;
        let userId;
        
        if (editingUserId) {
            // Update user
            // Build update payload - only include fields that are being updated
            const updatePayload = {
                first_name: formData.get('first_name'),
                last_name: formData.get('last_name'),
            };
            
            // Only include image_url if a new image was actually uploaded
            if (imageUrl) {
                updatePayload.image_url = imageUrl;
            }
            
            response = await fetch(`/api/tenants/${currentTenantId}/users/${editingUserId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify(updatePayload)
            });
            
            if (!response.ok) {
                let errorMessage = 'Failed to update user';
                try {
                    const error = await response.json();
                    // Handle Pydantic validation errors
                    if (error.detail) {
                        if (Array.isArray(error.detail)) {
                            // Pydantic validation errors are arrays
                            errorMessage = error.detail.map(e => `${e.loc.join('.')}: ${e.msg}`).join(', ');
                        } else {
                            errorMessage = error.detail;
                        }
                    }
                } catch (e) {
                    errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                }
                throw new Error(errorMessage);
            }
            
            userId = editingUserId;
        } else {
            // Add user - default password to "password123"
            response = await fetch(`/api/tenants/${currentTenantId}/users`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify({
                    email: formData.get('email'),
                    first_name: formData.get('first_name'),
                    last_name: formData.get('last_name'),
                    phone: '0000000000', // Default phone
                    image_url: imageUrl || null,
                    password: 'password123' // Default password
                })
            });
            
            if (!response.ok) {
                let errorMessage = 'Failed to create user';
                try {
                    const error = await response.json();
                    // Handle Pydantic validation errors
                    if (error.detail) {
                        if (Array.isArray(error.detail)) {
                            // Pydantic validation errors are arrays
                            errorMessage = error.detail.map(e => `${e.loc.join('.')}: ${e.msg}`).join(', ');
                        } else {
                            errorMessage = error.detail;
                        }
                    }
                } catch (e) {
                    errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                }
                throw new Error(errorMessage);
            }
            
            const user = await response.json();
            userId = user.id;
        }
        
        // Handle role assignment (single role)
        // Get current roles
        const currentRolesResponse = await fetch(`/api/tenants/${currentTenantId}/users/${userId}/roles`);
        const currentRoles = currentRolesResponse.ok ? await currentRolesResponse.json() : [];
        const currentRoleId = currentRoles.length > 0 ? currentRoles[0].id : null;
        
        // If role changed, update it
        if (currentRoleId !== selectedRoleId) {
            // Remove all existing roles
            for (const role of currentRoles) {
                await fetch(`/api/tenants/${currentTenantId}/users/${userId}/roles/${role.id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
            }
            
            // Assign the new role
            await fetch(`/api/tenants/${currentTenantId}/users/${userId}/roles/${selectedRoleId}`, {
                method: 'POST',
                credentials: 'include'
            });
        }
        
        closeUserModal();
        loadUsers();
        showMessage('User ' + (editingUserId ? 'updated' : 'created') + ' successfully', 'success');
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

// Utility functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showMessage(message, type) {
    // Create a temporary message div
    const msgDiv = document.createElement('div');
    msgDiv.style.cssText = `padding: 15px; border-radius: 6px; margin-bottom: 20px; 
                           background: ${type === 'success' ? '#d4edda' : '#f8d7da'}; 
                           color: ${type === 'success' ? '#155724' : '#721c24'};`;
    msgDiv.textContent = message;
    const container = document.querySelector('.content-section');
    container.insertBefore(msgDiv, container.firstChild);
    setTimeout(() => msgDiv.remove(), 5000);
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('userModal');
    if (event.target == modal) {
        closeUserModal();
    }
}

// Load users on page load
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
});
</script>
{% endblock %}
