{% extends "base.html" %}

{% block title %}Roles - Security - FinHealthMonitor{% endblock %}

{% block content %}
<div class="content-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div>
            <h2>Roles</h2>
            <p style="margin-top: 8px; color: #606060;">Manage roles and their permissions</p>
        </div>
        <button class="btn btn-primary" onclick="showAddRoleModal()" style="width: auto; height: auto; padding: 10px 20px;">
            <i class="las la-plus-circle" style="margin-right: 8px;"></i> Add Role
        </button>
    </div>

    {% if error %}
    <div style="background: #f8d7da; padding: 15px; border-radius: 6px; margin-bottom: 20px; color: #721c24;">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

    {% if success %}
    <div style="background: #d4edda; padding: 15px; border-radius: 6px; margin-bottom: 20px; color: #155724;">
        <strong>Success:</strong> {{ success }}
    </div>
    {% endif %}

    <div id="roles-table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Permissions</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="roles-table-body">
                <tr>
                    <td colspan="4" style="text-align: center; padding: 40px;">
                        <div style="color: #606060;">Loading roles...</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Edit Role Modal -->
<div id="roleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="roleModalTitle">Add New Role</h3>
            <span class="close" onclick="closeRoleModal()">&times;</span>
        </div>
        <form id="roleForm">
            <input type="hidden" id="roleId" name="role_id" />
            <div class="form-group">
                <label for="roleName">Role Name *</label>
                <input type="text" id="roleName" name="name" required placeholder="e.g., Accountant" />
            </div>
            <div class="form-group">
                <label for="roleDescription">Description</label>
                <textarea id="roleDescription" name="description" rows="3" placeholder="Describe the role's responsibilities"></textarea>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                <button type="button" onclick="closeRoleModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary" id="roleFormSubmit">Add Role</button>
            </div>
        </form>
    </div>
</div>

<!-- Manage Permissions Modal -->
<div id="permissionsModal" class="modal">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; display: flex; flex-direction: column;">
        <div class="modal-header" style="flex-shrink: 0;">
            <h3 id="permissionsModalTitle">Manage Permissions</h3>
            <span class="close" onclick="closePermissionsModal()">&times;</span>
        </div>
        <div style="padding: 20px; flex: 1; display: flex; flex-direction: column; overflow: hidden;">
            <!-- Search and Filter Section -->
            <div style="margin-bottom: 20px; flex-shrink: 0;">
                <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px;">
                    <div style="flex: 1; position: relative;">
                        <input type="text" id="permissionSearch" placeholder="Search permissions by resource or action..." 
                               style="width: 100%; padding: 10px 12px 10px 40px; border: 1px solid #E0E0E0; border-radius: 6px; font-size: 14px;"
                               onkeyup="filterPermissions()" />
                        <i class="las la-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #606060;"></i>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button type="button" onclick="selectAllPermissions()" class="btn btn-secondary" style="padding: 10px 16px; font-size: 14px;">
                            Select All
                        </button>
                        <button type="button" onclick="deselectAllPermissions()" class="btn btn-secondary" style="padding: 10px 16px; font-size: 14px;">
                            Deselect All
                        </button>
                    </div>
                </div>
                <div id="permissionSummary" style="padding: 10px 12px; background: #F5F6FA; border-radius: 6px; font-size: 14px; color: #202224;">
                    <strong id="selectedCount">0</strong> permission(s) selected
                </div>
            </div>
            
            <!-- Permissions Content - Scrollable -->
            <div id="permissionsContent" style="flex: 1; overflow-y: auto; border: 1px solid #E0E0E0; border-radius: 6px; padding: 16px; min-height: 0;">
                <div style="text-align: center; padding: 40px;">
                    <div style="color: #606060;">Loading permissions...</div>
                </div>
            </div>
        </div>
        <!-- Fixed Footer with Buttons -->
        <div style="display: flex; gap: 10px; justify-content: flex-end; padding: 20px; border-top: 1px solid #E0E0E0; flex-shrink: 0; background: white;">
            <button type="button" onclick="closePermissionsModal()" class="btn btn-secondary">Cancel</button>
            <button type="button" onclick="savePermissions()" class="btn btn-primary">Save Permissions</button>
        </div>
    </div>
</div>

<script>
let currentTenantId = null;
let editingRoleId = null;
let managingPermissionsRoleId = null;
let allPermissions = [];
let rolePermissions = [];

// Load current tenant
async function loadCurrentTenant() {
    if (!currentTenantId) {
        try {
            const response = await fetch('/api/tenants');
            if (response.ok) {
                const tenants = await response.json();
                if (tenants.length > 0) {
                    currentTenantId = tenants[0].id;
                }
            }
        } catch (error) {
            console.error('Error loading tenants:', error);
        }
    }
    return currentTenantId;
}

// Load roles
async function loadRoles() {
    if (!currentTenantId) {
        await loadCurrentTenant();
    }

    if (!currentTenantId) {
        document.getElementById('roles-table-body').innerHTML = 
            '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #dc3545;">No tenant found. Please contact administrator.</td></tr>';
        return;
    }

    try {
        const response = await fetch(`/api/tenants/${currentTenantId}/roles`);
        if (!response.ok) {
            throw new Error('Failed to load roles');
        }
        const roles = await response.json();
        displayRoles(roles);
    } catch (error) {
        console.error('Error loading roles:', error);
        document.getElementById('roles-table-body').innerHTML = 
            '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #dc3545;">Error loading roles: ' + error.message + '</td></tr>';
    }
}

// Display roles in table
async function displayRoles(roles) {
    const tbody = document.getElementById('roles-table-body');
    if (roles.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #606060;">No roles found. Click "Add Role" to create one.</td></tr>';
        return;
    }

    // Load permissions count for each role
    const rolesWithPermissions = await Promise.all(roles.map(async (role) => {
        try {
            const permResponse = await fetch(`/api/tenants/${currentTenantId}/roles/${role.id}/permissions`);
            if (permResponse.ok) {
                const permissions = await permResponse.json();
                return { ...role, permissionCount: permissions.length };
            }
        } catch (error) {
            console.error('Error loading permissions for role:', error);
        }
        return { ...role, permissionCount: 0 };
    }));

    tbody.innerHTML = rolesWithPermissions.map(role => {
        return `
            <tr>
                <td>${escapeHtml(role.name)}</td>
                <td>${escapeHtml(role.description || '-')}</td>
                <td>${role.permissionCount} permission(s)</td>
                <td>
                    <button class="icon-action-link" onclick="managePermissions('${role.id}')" title="Manage Permissions">
                        <i class="las la-key"></i>
                    </button>
                    <button class="icon-action-link" onclick="editRole('${role.id}')" title="Edit">
                        <i class="las la-edit"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Show add role modal
function showAddRoleModal() {
    editingRoleId = null;
    document.getElementById('roleModalTitle').textContent = 'Add New Role';
    document.getElementById('roleFormSubmit').textContent = 'Add Role';
    document.getElementById('roleId').value = '';
    document.getElementById('roleForm').reset();
    document.getElementById('roleModal').style.display = 'block';
}

// Edit role
async function editRole(roleId) {
    editingRoleId = roleId;
    try {
        const response = await fetch(`/api/tenants/${currentTenantId}/roles/${roleId}`);
        if (!response.ok) {
            throw new Error('Failed to load role details');
        }
        const role = await response.json();
        
        document.getElementById('roleModalTitle').textContent = 'Edit Role';
        document.getElementById('roleFormSubmit').textContent = 'Update Role';
        document.getElementById('roleId').value = role.id;
        document.getElementById('roleName').value = role.name;
        document.getElementById('roleDescription').value = role.description || '';
        
        // Disable editing system roles
        if (role.is_system_role === 'true') {
            document.getElementById('roleName').setAttribute('readonly', 'readonly');
            document.getElementById('roleName').style.background = '#f5f5f5';
        } else {
            document.getElementById('roleName').removeAttribute('readonly');
            document.getElementById('roleName').style.background = '';
        }
        
        document.getElementById('roleModal').style.display = 'block';
    } catch (error) {
        alert('Error loading role: ' + error.message);
    }
}

// Manage permissions for a role
async function managePermissions(roleId) {
    managingPermissionsRoleId = roleId;
    
    try {
        // Load all permissions
        const allPermsResponse = await fetch('/api/permissions');
        if (!allPermsResponse.ok) {
            throw new Error('Failed to load permissions');
        }
        allPermissions = await allPermsResponse.json();
        
        // Load role permissions
        const rolePermsResponse = await fetch(`/api/tenants/${currentTenantId}/roles/${roleId}/permissions`);
        if (!rolePermsResponse.ok) {
            throw new Error('Failed to load role permissions');
        }
        rolePermissions = await rolePermsResponse.json();
        const rolePermIds = new Set(rolePermissions.map(p => p.id));
        
        // Group permissions by resource
        const permissionsByResource = {};
        allPermissions.forEach(perm => {
            if (!permissionsByResource[perm.resource]) {
                permissionsByResource[perm.resource] = [];
            }
            permissionsByResource[perm.resource].push(perm);
        });
        
        // Build permissions UI with collapsible sections
        let html = '';
        let resourceIndex = 0;
        for (const [resource, perms] of Object.entries(permissionsByResource)) {
            const resourceId = `resource-${resourceIndex++}`;
            const checkedCount = perms.filter(p => rolePermIds.has(p.id)).length;
            const allChecked = checkedCount === perms.length;
            const someChecked = checkedCount > 0 && checkedCount < perms.length;
            
            html += `
                <div class="resource-section" data-resource="${escapeHtml(resource)}" style="margin-bottom: 16px; border: 1px solid #E0E0E0; border-radius: 6px; overflow: hidden;">
                    <div class="resource-header" onclick="toggleResource('${resourceId}')" 
                         style="padding: 12px 16px; background: #F5F6FA; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none;">
                        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                            <i class="las la-chevron-down resource-chevron" id="chevron-${resourceId}" style="transition: transform 0.2s; color: #606060;"></i>
                            <div>
                                <div style="font-weight: 600; color: #202224; font-size: 15px;">${escapeHtml(resource)}</div>
                                <div style="font-size: 12px; color: #606060; margin-top: 2px;">
                                    ${checkedCount} of ${perms.length} selected
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button type="button" onclick="event.stopPropagation(); selectResourcePermissions('${resourceId}')" 
                                    class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">
                                Select All
                            </button>
                            <label style="display: flex; align-items: center; cursor: pointer; margin: 0;" onclick="event.stopPropagation();">
                                <input type="checkbox" class="resource-checkbox" data-resource-id="${resourceId}" 
                                       ${allChecked ? 'checked' : ''} ${someChecked ? 'indeterminate' : ''}
                                       onchange="toggleResourcePermissions('${resourceId}', this.checked)"
                                       style="margin-right: 6px; width: 18px; height: 18px; cursor: pointer;">
                            </label>
                        </div>
                    </div>
                    <div class="resource-content" id="${resourceId}" style="display: none; padding: 16px; background: white;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
            `;
            
            perms.forEach(perm => {
                const checked = rolePermIds.has(perm.id) ? 'checked' : '';
                const permId = `perm-${perm.id}`;
                html += `
                    <label class="permission-item" data-perm-id="${perm.id}" data-resource="${escapeHtml(resource)}" data-action="${escapeHtml(perm.action)}"
                           style="display: flex; align-items: center; padding: 10px 12px; background: #F5F6FA; border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;">
                        <input type="checkbox" id="${permId}" value="${perm.id}" ${checked} 
                               onchange="updatePermissionSummary()"
                               style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: #202224; font-size: 14px;">${escapeHtml(perm.action)}</div>
                            ${perm.description ? `<div style="font-size: 12px; color: #606060; margin-top: 2px;">${escapeHtml(perm.description)}</div>` : ''}
                        </div>
                    </label>
                `;
            });
            
            html += `
                        </div>
                    </div>
                </div>
            `;
        }
        
        document.getElementById('permissionsContent').innerHTML = html;
        document.getElementById('permissionsModalTitle').textContent = 'Manage Permissions';
        updatePermissionSummary();
        document.getElementById('permissionsModal').style.display = 'block';
    } catch (error) {
        alert('Error loading permissions: ' + error.message);
    }
}

// Toggle resource section
function toggleResource(resourceId) {
    const content = document.getElementById(resourceId);
    const chevron = document.getElementById('chevron-' + resourceId);
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        chevron.style.transform = 'rotate(0deg)';
    } else {
        content.style.display = 'none';
        chevron.style.transform = 'rotate(-90deg)';
    }
}

// Toggle all permissions in a resource
function toggleResourcePermissions(resourceId, checked) {
    const resourceContent = document.getElementById(resourceId);
    const checkboxes = resourceContent.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(cb => {
        cb.checked = checked;
    });
    updatePermissionSummary();
    updateResourceCheckbox(resourceId);
}

// Select all permissions in a resource
function selectResourcePermissions(resourceId) {
    toggleResourcePermissions(resourceId, true);
}

// Update resource checkbox state
function updateResourceCheckbox(resourceId) {
    const resourceContent = document.getElementById(resourceId);
    const checkboxes = resourceContent.querySelectorAll('input[type="checkbox"]');
    const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
    const resourceCheckbox = document.querySelector(`.resource-checkbox[data-resource-id="${resourceId}"]`);
    
    if (checkedCount === 0) {
        resourceCheckbox.checked = false;
        resourceCheckbox.indeterminate = false;
    } else if (checkedCount === checkboxes.length) {
        resourceCheckbox.checked = true;
        resourceCheckbox.indeterminate = false;
    } else {
        resourceCheckbox.checked = false;
        resourceCheckbox.indeterminate = true;
    }
}

// Select all permissions
function selectAllPermissions() {
    const allCheckboxes = document.querySelectorAll('#permissionsContent input[type="checkbox"]:not(.resource-checkbox)');
    allCheckboxes.forEach(cb => cb.checked = true);
    updatePermissionSummary();
    // Update all resource checkboxes
    document.querySelectorAll('.resource-section').forEach(section => {
        const resourceId = section.querySelector('.resource-content').id;
        updateResourceCheckbox(resourceId);
    });
}

// Deselect all permissions
function deselectAllPermissions() {
    const allCheckboxes = document.querySelectorAll('#permissionsContent input[type="checkbox"]:not(.resource-checkbox)');
    allCheckboxes.forEach(cb => cb.checked = false);
    updatePermissionSummary();
    // Update all resource checkboxes
    document.querySelectorAll('.resource-section').forEach(section => {
        const resourceId = section.querySelector('.resource-content').id;
        updateResourceCheckbox(resourceId);
    });
}

// Filter permissions by search term
function filterPermissions() {
    const searchTerm = document.getElementById('permissionSearch').value.toLowerCase();
    const resourceSections = document.querySelectorAll('.resource-section');
    
    resourceSections.forEach(section => {
        const resource = section.getAttribute('data-resource').toLowerCase();
        const permissionItems = section.querySelectorAll('.permission-item');
        let hasMatch = false;
        
        permissionItems.forEach(item => {
            const action = item.getAttribute('data-action').toLowerCase();
            const description = item.textContent.toLowerCase();
            const matches = resource.includes(searchTerm) || action.includes(searchTerm) || description.includes(searchTerm);
            
            if (matches) {
                item.style.display = 'flex';
                hasMatch = true;
            } else {
                item.style.display = 'none';
            }
        });
        
        // Show/hide resource section based on matches
        if (hasMatch || searchTerm === '') {
            section.style.display = 'block';
            // Auto-expand if searching
            if (searchTerm !== '') {
                const resourceId = section.querySelector('.resource-content').id;
                const content = document.getElementById(resourceId);
                if (content.style.display === 'none') {
                    toggleResource(resourceId);
                }
            }
        } else {
            section.style.display = 'none';
        }
    });
}

// Update permission summary count
function updatePermissionSummary() {
    const checkedBoxes = document.querySelectorAll('#permissionsContent input[type="checkbox"]:not(.resource-checkbox):checked');
    const count = checkedBoxes.length;
    document.getElementById('selectedCount').textContent = count;
    
    // Update resource checkboxes
    document.querySelectorAll('.resource-section').forEach(section => {
        const resourceId = section.querySelector('.resource-content').id;
        updateResourceCheckbox(resourceId);
    });
}

// Save permissions
async function savePermissions() {
    if (!managingPermissionsRoleId) return;
    
    const checkboxes = document.querySelectorAll('#permissionsContent input[type="checkbox"]:not(.resource-checkbox):checked');
    const selectedPermissionIds = Array.from(checkboxes).map(cb => cb.value);
    
    try {
        // Get current permissions
        const currentResponse = await fetch(`/api/tenants/${currentTenantId}/roles/${managingPermissionsRoleId}/permissions`);
        const currentPermissions = await currentResponse.ok ? await currentResponse.json() : [];
        const currentPermIds = new Set(currentPermissions.map(p => p.id));
        
        // Remove unselected permissions
        for (const perm of currentPermissions) {
            if (!selectedPermissionIds.includes(perm.id)) {
                await fetch(`/api/tenants/${currentTenantId}/roles/${managingPermissionsRoleId}/permissions/${perm.id}`, {
                    method: 'DELETE'
                });
            }
        }
        
        // Add new permissions
        for (const permId of selectedPermissionIds) {
            if (!currentPermIds.has(permId)) {
                await fetch(`/api/tenants/${currentTenantId}/roles/${managingPermissionsRoleId}/permissions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ permission_id: permId })
                });
            }
        }
        
        closePermissionsModal();
        loadRoles();
        showMessage('Permissions updated successfully', 'success');
    } catch (error) {
        alert('Error saving permissions: ' + error.message);
    }
}

// Close modals
function closeRoleModal() {
    document.getElementById('roleModal').style.display = 'none';
    editingRoleId = null;
}

function closePermissionsModal() {
    document.getElementById('permissionsModal').style.display = 'none';
    managingPermissionsRoleId = null;
}

// Handle role form submission
document.getElementById('roleForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    try {
        let response;
        if (editingRoleId) {
            // Update role
            response = await fetch(`/api/tenants/${currentTenantId}/roles/${editingRoleId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: data.name,
                    description: data.description || null
                })
            });
        } else {
            // Add role
            response = await fetch(`/api/tenants/${currentTenantId}/roles`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: data.name,
                    description: data.description || null
                })
            });
        }
        
        const result = await response.json();
        
        if (response.ok) {
            closeRoleModal();
            loadRoles();
            showMessage('Role ' + (editingRoleId ? 'updated' : 'created') + ' successfully', 'success');
        } else {
            alert('Error: ' + (result.detail || 'Failed to save role'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

// Utility functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showMessage(message, type) {
    const msgDiv = document.createElement('div');
    msgDiv.style.cssText = `padding: 15px; border-radius: 6px; margin-bottom: 20px; 
                           background: ${type === 'success' ? '#d4edda' : '#f8d7da'}; 
                           color: ${type === 'success' ? '#155724' : '#721c24'};`;
    msgDiv.textContent = message;
    const container = document.querySelector('.content-section');
    container.insertBefore(msgDiv, container.firstChild);
    setTimeout(() => msgDiv.remove(), 5000);
}

// Close modals when clicking outside
window.onclick = function(event) {
    const roleModal = document.getElementById('roleModal');
    const permModal = document.getElementById('permissionsModal');
    if (event.target == roleModal) {
        closeRoleModal();
    }
    if (event.target == permModal) {
        closePermissionsModal();
    }
}

// Load roles on page load
document.addEventListener('DOMContentLoaded', function() {
    loadRoles();
});
</script>
{% endblock %}
