{% extends "base.html" %}

{% block title %}Connections - FinHealthMonitor{% endblock %}

{% block extra_js %}
<script>
        // CRITICAL: Define function DIRECTLY on window - no IIFE, no scope issues
        // This MUST be the first thing in the script to ensure it's always available
        try {
            window.showAddConnectionModal = function(category) {
                try {
                    var categoryInput = document.getElementById('modal-category');
                    var softwareSelect = document.getElementById('modal-software');
                    var nameInput = document.getElementById('modal-name');
                    var modal = document.getElementById('addConnectionModal');
                    
                    if (!categoryInput || !softwareSelect || !modal) {
                        alert('Error: Modal elements not found. Please refresh the page.');
                        return false;
                    }
                    
                    var softwareOptions = window.softwareOptions;
                    if (!softwareOptions) {
                        alert('Error: Software options not loaded. Please refresh the page.');
                        return false;
                    }
                    
                    categoryInput.value = category;
                    softwareSelect.innerHTML = '<option value="">Select software...</option>';
                    if (nameInput) nameInput.value = '';
                    
                    if (!softwareOptions[category]) {
                        alert('Error: No software options available for this category.');
                        return false;
                    }
                    
                    var categorySoftware = softwareOptions[category];
                    for (var key in categorySoftware) {
                        if (categorySoftware.hasOwnProperty(key)) {
                            var info = categorySoftware[key];
                            var option = document.createElement('option');
                            option.value = key;
                            var displayName = info.name || key.charAt(0).toUpperCase() + key.slice(1);
                            option.textContent = displayName;
                            softwareSelect.appendChild(option);
                        }
                    }
                    
                    modal.style.display = 'block';
                    return true;
                } catch (e) {
                    alert('Error opening modal: ' + e.message);
                    return false;
                }
            };
        } catch (e) {
            // Fallback definition
            window.showAddConnectionModal = function(cat) {
                alert('Error: Function definition failed. Please refresh the page.');
            };
        }
        
        try {
            window.closeAddConnectionModal = function() {
                var modal = document.getElementById('addConnectionModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            };
        } catch (e) {
            // Silent fail
        }
        
        // Load software options - AFTER functions are defined
        // This is in a separate try-catch so errors here don't prevent function definition
        window.softwareOptions = {};
        try {
            window.softwareOptions = JSON.parse('{{ software_options|tojson|safe }}');
        } catch (e) {
            window.softwareOptions = {};
        }
        
        // Final verification and fallback
        if (typeof window.showAddConnectionModal !== 'function') {
            // Last resort fallback - define a minimal version
            window.showAddConnectionModal = function(cat) {
                alert('Error: Modal function failed to load properly. Please refresh the page.');
            };
        }
    </script>
{% endblock %}

{% block content %}
    {% if error %}
    <div style="background: #f8d7da; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
        <p><strong>Error:</strong> {{ error }}</p>
    </div>
    {% endif %}

    {% if success %}
    <div style="background: #d4edda; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
        <p><strong>Success:</strong> {{ success }}</p>
    </div>
    {% endif %}

    <h2>Connections</h2>
    <p>Manage your integrations and connections.</p>

            {% set conn_ui_flags = get_resource_ui_flags('connections') if get_resource_ui_flags else {'show_add': False, 'show_edit': False, 'show_refresh': False, 'show_add_tenant': False, 'show_remove': False} %}
            {% for category_key, category_info in categories.items() %}
            <div class="category-section">
                <div class="category-header">
                    <h3 class="category-title">{{ category_info.name }}</h3>
                </div>

                {% if connections_by_category.get(category_key) %}
                    {% for connection in connections_by_category[category_key] %}
                    <div class="connection-card" data-connection-id="{{ connection.id }}">
                        <div class="connection-header">
                            <div class="connection-info">
                                <div class="connection-name">
                                    <div class="connection-name-display">
                                        <span id="name-display-{{ connection.id }}">{{ connection.name }}</span>
                                        {% if conn_ui_flags.show_edit %}
                                        <a href="#" class="edit-icon-link" onclick="event.preventDefault(); editConnectionName('{{ connection.id }}'); return false;" title="Edit name">
                                            <i class="las la-edit"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                    <div class="connection-name-edit" id="name-edit-{{ connection.id }}">
                                        <input type="text" id="name-input-{{ connection.id }}" value="{{ connection.name }}" />
                                        <button type="button" class="btn btn-primary" onclick="saveConnectionName('{{ connection.id }}')" title="Save" style="width: auto; height: auto; padding: 8px 16px;">
                                            Save
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="cancelEditName('{{ connection.id }}')" title="Cancel" style="width: auto; height: auto; padding: 8px 16px;">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                                <div class="connection-meta">
                                    <span class="status-badge {% if connection.access_token and not connection.get('token_expired') %}status-completed{% elif connection.get('token_expired') %}status-onhold{% else %}status-failed{% endif %}">
                                        <span>
                                            {% if connection.access_token and not connection.get('token_expired') %}
                                                Connected
                                            {% elif connection.get('token_expired') %}
                                                Expired - Click Refresh to renew
                                            {% else %}
                                                Not Connected
                                            {% endif %}
                                        </span>
                                    </span>
                                    {% if connection.software == 'xero' %}
                                    <span>Type: Xero</span>
                                    {% set tenants = connection.get('tenants', []) %}
                                    {% if tenants %}
                                    <span>{{ tenants|length }} tenant(s)</span>
                                    {% endif %}
                                    {% elif connection.software == 'quickbooks' %}
                                    <span>Type: QuickBooks</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="connection-actions">
                                {% if connection.access_token %}
                                    {% if conn_ui_flags.show_refresh %}
                                    {% if connection.get('token_expired') %}
                                    <form method="post" action="/connections/{{ connection.id }}/refresh" style="margin: 0; display: inline;">
                                        <button type="submit" class="icon-action-link" title="Refresh Expired Token" style="background: none; border: none; padding: 0; cursor: pointer;">
                                            <i class="las la-sync-alt"></i>
                                        </button>
                                    </form>
                                    {% else %}
                                    <form method="post" action="/connections/{{ connection.id }}/refresh" style="margin: 0; display: inline;">
                                        <button type="submit" class="icon-action-link" title="Refresh Token" style="background: none; border: none; padding: 0; cursor: pointer;">
                                            <i class="las la-sync-alt"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                    {% endif %}
                                    {% if connection.software == 'xero' and conn_ui_flags.show_add_tenant %}
                                    <form method="post" action="/connections/{{ connection.id }}/add-tenant" style="margin: 0; display: inline;">
                                        <button type="submit" class="icon-action-link" title="Add Tenant" style="background: none; border: none; padding: 0; cursor: pointer;">
                                            <i class="las la-plus-circle"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                    {% if conn_ui_flags.show_remove %}
                                    <form method="post" action="/connections/{{ connection.id }}/disconnect-all" style="margin: 0; display: inline;">
                                        <button type="submit" class="icon-action-link danger" title="Disconnect All" onclick="return confirm('Are you sure you want to disconnect all tenants? This will revoke access with Xero for all tenants.')" style="background: none; border: none; padding: 0; cursor: pointer;">
                                            <i class="las la-unlink"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                {% else %}
                                <a href="/connections/{{ connection.id }}/connect" class="btn btn-primary" title="Connect" style="width: auto; height: auto; padding: 8px 16px; text-decoration: none;">
                                    Connect
                                </a>
                                {% if conn_ui_flags.show_remove %}
                                <form method="post" action="/connections/{{ connection.id }}/delete" style="margin: 0; display: inline;">
                                    <button type="submit" class="btn btn-secondary" title="Delete" onclick="return confirm('Are you sure you want to delete this connection?')" style="width: auto; height: auto; padding: 8px 16px; background: #dc3545;">
                                        Delete
                                    </button>
                                </form>
                                {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        {% if connection.access_token and connection.get('tenants') %}
                        <div class="tenants-section" style="margin-top: 24px; padding-top: 20px; border-top: 0.6px solid #E0E0E0;">
                            <h4 style="margin: 0 0 16px 0;">Tenants</h4>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                {% for tenant in connection.get('tenants', []) %}
                                <li class="tenant-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; margin-bottom: 8px; background: #F5F6FA; border-radius: 8px; border: 0.3px solid #E0E0E0;">
                                    <span style="font-family: 'Nunito Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; font-style: normal; font-weight: 600; font-size: 16px; line-height: 22px; color: #202224;">{{ tenant.get('tenant_name', 'Unknown') }}</span>
                                    <span style="font-family: 'Nunito Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; font-style: normal; font-weight: 400; font-size: 14px; line-height: 19px; color: #606060; margin-left: 12px;">({{ tenant.get('tenant_id', '')[:8] }}...)</span>
                                    {% if conn_ui_flags.show_remove %}
                                    <form method="post" action="/connections/{{ connection.id }}/remove-tenant" style="margin: 0 0 0 16px; display: inline;">
                                        <input type="hidden" name="tenant_id" value="{{ tenant.get('tenant_id') }}" />
                                        <button type="submit" class="remove-icon-link" title="Remove Tenant" onclick="return confirm('Are you sure you want to remove this tenant? This will disconnect it from Xero.')" style="background: none; border: none; padding: 0; cursor: pointer;">
                                            <i class="las la-times-circle"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% endif %}

                <!-- Add Connection Button for this category -->
                {% if conn_ui_flags.show_add %}
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary" data-category="{{ category_key }}" type="button" style="width: auto; height: auto; padding: 8px 16px;">
                        <i class="las la-plus-circle" style="margin-right: 8px;"></i> Add Connection
                    </button>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

    <!-- Hidden element to store software options (avoids JavaScript syntax issues) -->
    <div id="software-options-data" data-options='{{ software_options|tojson }}' style="display: none;"></div>

    <!-- Add Connection Modal -->
    <div id="addConnectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Connection</h3>
                <span class="close" onclick="if(window.closeAddConnectionModal){window.closeAddConnectionModal();}else{alert('Error: Function not loaded. Please refresh.');}">&times;</span>
            </div>
            <form method="post" action="/connections/add" id="addConnectionForm">
                <input type="hidden" name="category" id="modal-category" />
                <div class="form-group">
                    <label for="modal-software">Software *</label>
                    <select name="software" id="modal-software" required>
                        <option value="">Select software...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="modal-name">Connection Name *</label>
                    <input type="text" name="name" id="modal-name" required placeholder="e.g., Main Xero Account" />
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" onclick="if(window.closeAddConnectionModal){window.closeAddConnectionModal();}else{alert('Error: Function not loaded. Please refresh.');}" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add & Connect</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Load software options from data attribute (avoids JavaScript syntax issues)
        try {
            var dataElement = document.getElementById('software-options-data');
            if (dataElement) {
                var dataOptions = dataElement.getAttribute('data-options');
                if (dataOptions) {
                    var softwareOptionsJson = JSON.parse(dataOptions);
                    if (!window.softwareOptions || Object.keys(window.softwareOptions).length === 0) {
                        window.softwareOptions = softwareOptionsJson;
                    }
                } else {
                    window.softwareOptions = window.softwareOptions || {};
                }
            } else {
                window.softwareOptions = window.softwareOptions || {};
            }
        } catch (e) {
            window.softwareOptions = window.softwareOptions || {};
        }
        
        // Define showAddConnectionModal function
        function showAddConnectionModal(category) {
            try {
                var categoryInput = document.getElementById('modal-category');
                var softwareSelect = document.getElementById('modal-software');
                var nameInput = document.getElementById('modal-name');
                var modal = document.getElementById('addConnectionModal');
                
                if (!categoryInput || !softwareSelect || !modal) {
                    alert('Error: Modal elements not found. Please refresh the page.');
                    return false;
                }
                
                var softwareOptions = window.softwareOptions;
                if (!softwareOptions || Object.keys(softwareOptions).length === 0) {
                    alert('Error: Software options not loaded. Please refresh the page.');
                    return false;
                }
                
                categoryInput.value = category;
                softwareSelect.innerHTML = '<option value="">Select software...</option>';
                if (nameInput) nameInput.value = '';
                
                if (!softwareOptions[category]) {
                    alert('Error: No software options available for this category.');
                    return false;
                }
                
                var categorySoftware = softwareOptions[category];
                for (var key in categorySoftware) {
                    if (categorySoftware.hasOwnProperty(key)) {
                        var info = categorySoftware[key];
                        var option = document.createElement('option');
                        option.value = key;
                        var displayName = info.name || key.charAt(0).toUpperCase() + key.slice(1);
                        option.textContent = displayName;
                        softwareSelect.appendChild(option);
                    }
                }
                
                modal.style.display = 'block';
                return true;
            } catch (e) {
                alert('Error opening modal: ' + e.message);
                return false;
            }
        }
        
        function closeAddConnectionModal() {
            var modal = document.getElementById('addConnectionModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Make functions globally available
        window.showAddConnectionModal = showAddConnectionModal;
        window.closeAddConnectionModal = closeAddConnectionModal;
        
        function editConnectionName(connectionId) {
            document.getElementById('name-display-' + connectionId).classList.add('hidden');
            document.getElementById('name-edit-' + connectionId).classList.add('active');
        }
        
        function cancelEditName(connectionId) {
            document.getElementById('name-display-' + connectionId).classList.remove('hidden');
            document.getElementById('name-edit-' + connectionId).classList.remove('active');
            document.getElementById('name-input-' + connectionId).value = document.getElementById('name-display-' + connectionId).textContent.trim();
        }
        
        function saveConnectionName(connectionId) {
            const newName = document.getElementById('name-input-' + connectionId).value.trim();
            if (!newName) {
                alert('Name cannot be empty');
                return;
            }
            
            fetch('/connections/' + connectionId + '/rename', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'name=' + encodeURIComponent(newName)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('name-display-' + connectionId).textContent = newName;
                    cancelEditName(connectionId);
                } else {
                    alert('Error: ' + (data.error || 'Failed to update name'));
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        }
        
        function validateConnectionForm() {
            const softwareSelect = document.getElementById('modal-software');
            const nameInput = document.getElementById('modal-name');
            
            if (!softwareSelect || !softwareSelect.value) {
                alert('Please select a software type.');
                return false;
            }
            
            if (!nameInput || !nameInput.value.trim()) {
                alert('Please enter a connection name.');
                return false;
            }
            
            return true;
        }
        
        // Safari-compatible helper function
        function findButtonWithClass(element, className) {
            var current = element;
            var depth = 0;
            while (current && current !== document && depth < 10) {
                if (current.classList && current.classList.contains(className)) {
                    return current;
                }
                current = current.parentNode;
                depth++;
            }
            return null;
        }
        
        // Handle ALL DOMContentLoaded tasks in one handler
        document.addEventListener('DOMContentLoaded', function() {
            // Handle clicks on "Add Connection" buttons using event delegation
            document.addEventListener('click', function(e) {
                var button = findButtonWithClass(e.target, 'btn-primary');
                if (button && button.getAttribute('data-category')) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    var category = button.getAttribute('data-category');
                    if (category && window.showAddConnectionModal) {
                        window.showAddConnectionModal(category);
                    } else {
                        alert('Error: Unable to open connection modal. Please refresh the page.');
                    }
                    return false;
                }
            });
            
            // Handle form submission
            const form = document.getElementById('addConnectionForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    const softwareSelect = document.getElementById('modal-software');
                    const nameInput = document.getElementById('modal-name');
                    
                    if (!softwareSelect || !softwareSelect.value) {
                        e.preventDefault();
                        alert('Please select a software type.');
                        return false;
                    }
                    
                    if (!nameInput || !nameInput.value.trim()) {
                        e.preventDefault();
                        alert('Please enter a connection name.');
                        return false;
                    }
                    
                    return true;
                });
            }
            
            // Close modal when clicking outside
            const modal = document.getElementById('addConnectionModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        if (window.closeAddConnectionModal) {
                            window.closeAddConnectionModal();
                        }
                    }
                }, false);
            }
        });
        
        // Close modal when clicking outside (global handler)
        window.onclick = function(event) {
            const modal = document.getElementById('addConnectionModal');
            if (event.target == modal) {
                if (window.closeAddConnectionModal) {
                    window.closeAddConnectionModal();
                }
            }
        }
        
    </script>
{% endblock %}
